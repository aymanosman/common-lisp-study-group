(in-package :raylib)

(defvar font)

(defstruct font advance width height texture)

(defun make-font-atlas (sprites width height)
  (let* ((image (gen-image-color (* 10 width) (* 10 height) +blank+))
         (image-pointer (alloc-image image)))
    (flet ((draw-sprite (sprite x y)
             (loop :for j :from 0 :below height
                   :do (loop :for i :from 0 :below width
                             :do (when (= 1 (aref (aref sprite j) i))
                                   (image-draw-pixel image-pointer (+ i x) (+ j y) +white+))))))

      (loop for sprite across sprites
            for i from 0
            do (multiple-value-bind (row col) (floor i 10)
                 (draw-sprite sprite (* col 8) (* row 6))))
      (load-texture-from-image image))))

(defun make-font-from-sprites (sprites &key advance)
  (let* ((width 8)
         (height 6))
    (make-font :advance advance
               :width width
               :height height
               :texture (make-font-atlas sprites width height))))

(defun debug-font-atlas ()
  (with-slots (width height texture) font
    (draw-texture-rec texture
                      (make-rectangle :x 0 :y 0
                                      :width (* 10 width)
                                      :height (* 10 height))
                      (make-vector2 :x 0 :y 0)
                      +white+)))

(defun text (x y color text)
  (with-slots (advance width height texture) font
    (let (;; TODO hardcoded game-screen-width
          (max-width 128))
      (loop for x from x below max-width by (font-advance font)
            for c across text
            do (when (not (char= #\space c))
                 (multiple-value-bind (row col) (floor (- (char-code c) 33) 10) ;; 10 because 10x10 grid
                   (draw-texture-rec texture
                                     (make-rectangle :x (* col width)
                                                     :y (* row height)
                                                     :width advance
                                                     :height height)
                                     (make-vector2 :x x :y y)
                                     color)))))))

(defvar basic-font
  #(;; !
    #(#*01000000
      #*01000000
      #*01000000
      #*00000000
      #*01000000
      #*00000000
      )
    ;; "
    #(#*10100000
      #*10100000
      #*00000000
      #*00000000
      #*00000000
      #*00000000
      )
    ;; #
    #(#*10100000
      #*11100000
      #*10100000
      #*11100000
      #*10100000
      #*00000000
      )
    ;; $
    #(#*01000000
      #*01100000
      #*11000000
      #*01100000
      #*11000000
      #*01000000
      )
    ;; %
    #(#*10100000
      #*00100000
      #*01000000
      #*10000000
      #*10100000
      #*00000000
      )
    ;; &
    #(#*11000000
      #*11000000
      #*10000000
      #*11100000
      #*11000000
      #*00000000
      )
    ;; '
    #(#*01000000
      #*01000000
      #*00000000
      #*00000000
      #*00000000
      #*00000000
      )
    ;; (
    #(#*00100000
      #*01000000
      #*01000000
      #*01000000
      #*00100000
      #*00000000
      )
    ;; )
    #(#*10000000
      #*01000000
      #*01000000
      #*01000000
      #*10000000
      #*00000000
      )
    ;; *
    #(#*00000000
      #*10100000
      #*01000000
      #*10100000
      #*00000000
      #*00000000
      )
    ;; +
    #(#*00000000
      #*01000000
      #*11100000
      #*01000000
      #*00000000
      #*00000000
      )
    ;; ,
    #(#*00000000
      #*00000000
      #*00000000
      #*01000000
      #*01000000
      #*10000000
      )
    ;; -
    #(#*00000000
      #*00000000
      #*11100000
      #*00000000
      #*00000000
      #*00000000
      )
    ;; .
    #(#*00000000
      #*00000000
      #*00000000
      #*00000000
      #*01000000
      #*00000000
      )
    ;; /
    #(#*00100000
      #*00100000
      #*01000000
      #*10000000
      #*10000000
      #*00000000
      )
    ;; 0
    #(#*01100000
      #*10100000
      #*10100000
      #*10100000
      #*11000000
      #*00000000
      )
    ;; 1
    #(#*01000000
      #*11000000
      #*01000000
      #*01000000
      #*11100000
      #*00000000
      )
    ;; 2
    #(#*11000000
      #*00100000
      #*01000000
      #*10000000
      #*11100000
      #*00000000
      )
    ;; 3
    #(#*11000000
      #*00100000
      #*01000000
      #*00100000
      #*11000000
      #*00000000
      )
    ;; 4
    #(#*10100000
      #*10100000
      #*11100000
      #*00100000
      #*00100000
      #*00000000
      )
    ;; 5
    #(#*11100000
      #*10000000
      #*11000000
      #*00100000
      #*11000000
      #*00000000
      )
    ;; 6
    #(#*01100000
      #*10000000
      #*11100000
      #*10100000
      #*11100000
      #*00000000
      )
    ;; 7
    #(#*11100000
      #*00100000
      #*01000000
      #*10000000
      #*10000000
      #*00000000
      )
    ;; 8
    #(#*11100000
      #*10100000
      #*11100000
      #*10100000
      #*11100000
      #*00000000
      )
    ;; 9
    #(#*11100000
      #*10100000
      #*11100000
      #*00100000
      #*00100000
      #*00000000
      )
    ;; :
    #(#*00000000
      #*01000000
      #*00000000
      #*01000000
      #*00000000
      #*00000000
      )
    ;; ;
    #(#*00000000
      #*01000000
      #*00000000
      #*01000000
      #*01000000
      #*10000000
      )
    ;; <
    #(#*00100000
      #*01000000
      #*10000000
      #*01000000
      #*00100000
      #*00000000
      )
    ;; =
    #(#*00000000
      #*11100000
      #*00000000
      #*11100000
      #*00000000
      #*00000000
      )
    ;; >
    #(#*10000000
      #*01000000
      #*00100000
      #*01000000
      #*10000000
      #*00000000
      )
    ;; ?
    #(#*11000000
      #*00100000
      #*01000000
      #*00000000
      #*01000000
      #*00000000
      )
    ;; @
    #(#*01100000
      #*11100000
      #*10000000
      #*10000000
      #*01100000
      #*00000000
      )
    ;; A
    #(#*01000000
      #*10100000
      #*11100000
      #*10100000
      #*10100000
      #*00000000
      )
    ;; B
    #(#*11000000
      #*10100000
      #*11000000
      #*10100000
      #*11000000
      #*00000000
      )
    ;; C
    #(#*01000000
      #*10100000
      #*10000000
      #*10100000
      #*01000000
      #*00000000
      )
    ;; D
    #(#*11000000
      #*10100000
      #*10100000
      #*10100000
      #*11000000
      #*00000000
      )
    ;; E
    #(#*11100000
      #*10000000
      #*11000000
      #*10000000
      #*11100000
      #*00000000
      )
    ;; F
    #(#*11100000
      #*10000000
      #*11000000
      #*10000000
      #*10000000
      #*00000000
      )
    ;; G
    #(#*01100000
      #*10000000
      #*10100000
      #*10100000
      #*11000000
      #*00000000
      )
    ;; H
    #(#*10100000
      #*10100000
      #*11100000
      #*10100000
      #*10100000
      #*00000000
      )
    ;; I
    #(#*11100000
      #*01000000
      #*01000000
      #*01000000
      #*11100000
      #*00000000
      )
    ;; J
    #(#*11100000
      #*00100000
      #*00100000
      #*10100000
      #*11000000
      #*00000000
      )
    ;; K
    #(#*10100000
      #*10100000
      #*11000000
      #*10100000
      #*10100000
      #*00000000
      )
    ;; L
    #(#*10000000
      #*10000000
      #*10000000
      #*10000000
      #*11100000
      #*00000000
      )
    ;; M
    #(#*10100000
      #*11100000
      #*10100000
      #*10100000
      #*10100000
      #*00000000
      )
    ;; N
    #(#*11000000
      #*10100000
      #*10100000
      #*10100000
      #*10100000
      #*00000000
      )
    ;; O
    #(#*01000000
      #*10100000
      #*10100000
      #*10100000
      #*01000000
      #*00000000
      )
    ;; P
    #(#*11000000
      #*10100000
      #*11000000
      #*10000000
      #*10000000
      #*00000000
      )
    ;; Q
    #(#*01000000
      #*10100000
      #*10100000
      #*11100000
      #*01100000
      #*00000000
      )
    ;; R
    #(#*11000000
      #*10100000
      #*11000000
      #*10100000
      #*10100000
      #*00000000
      )
    ;; S
    #(#*01100000
      #*10000000
      #*01000000
      #*00100000
      #*11000000
      #*00000000
      )
    ;; T
    #(#*11100000
      #*01000000
      #*01000000
      #*01000000
      #*01000000
      #*00000000
      )
    ;; U
    #(#*10100000
      #*10100000
      #*10100000
      #*10100000
      #*11100000
      #*00000000
      )
    ;; V
    #(#*10100000
      #*10100000
      #*10100000
      #*10100000
      #*01000000
      #*00000000
      )
    ;; W
    #(#*10100000
      #*10100000
      #*10100000
      #*11100000
      #*10100000
      #*00000000
      )
    ;; X
    #(#*10100000
      #*10100000
      #*01000000
      #*10100000
      #*10100000
      #*00000000
      )
    ;; Y
    #(#*10100000
      #*10100000
      #*01000000
      #*01000000
      #*01000000
      #*00000000
      )
    ;; Z
    #(#*11100000
      #*00100000
      #*01000000
      #*10000000
      #*11100000
      #*00000000
      )
    ;; [
    #(#*01100000
      #*01000000
      #*01000000
      #*01000000
      #*01100000
      #*00000000
      )
    ;; \
    #(#*10000000
      #*10000000
      #*01000000
      #*00100000
      #*00100000
      #*00000000
      )
    ;; ]
    #(#*11000000
      #*01000000
      #*01000000
      #*01000000
      #*11000000
      #*00000000
      )
    ;; ^
    #(#*01000000
      #*10100000
      #*00000000
      #*00000000
      #*00000000
      #*00000000
      )
    ;; _
    #(#*00000000
      #*00000000
      #*00000000
      #*00000000
      #*11100000
      #*00000000
      )
    ;; `
    #(#*10000000
      #*01000000
      #*00000000
      #*00000000
      #*00000000
      #*00000000
      )
    ;; a
    #(#*00000000
      #*01100000
      #*10100000
      #*10100000
      #*01100000
      #*00000000
      )
    ;; b
    #(#*10000000
      #*11000000
      #*10100000
      #*10100000
      #*11000000
      #*00000000
      )
    ;; c
    #(#*00000000
      #*01100000
      #*10000000
      #*10000000
      #*01100000
      #*00000000
      )
    ;; d
    #(#*00100000
      #*01100000
      #*10100000
      #*10100000
      #*01100000
      #*00000000
      )
    ;; e
    #(#*00000000
      #*01000000
      #*11100000
      #*10000000
      #*01100000
      #*00000000
      )
    ;; f
    #(#*01100000
      #*01000000
      #*11100000
      #*01000000
      #*01000000
      #*00000000
      )
    ;; g
    #(#*00000000
      #*11000000
      #*10100000
      #*11100000
      #*00100000
      #*11100000
      )
    ;; h
    #(#*10000000
      #*11000000
      #*10100000
      #*10100000
      #*10100000
      #*00000000
      )
    ;; i
    #(#*01000000
      #*00000000
      #*01000000
      #*01000000
      #*01000000
      #*00000000
      )
    ;; j
    #(#*01000000
      #*00000000
      #*01000000
      #*01000000
      #*01000000
      #*11000000
      )
    ;; k
    #(#*10000000
      #*10100000
      #*10100000
      #*11000000
      #*10100000
      #*00000000
      )
    ;; l
    #(#*01000000
      #*01000000
      #*01000000
      #*01000000
      #*01000000
      #*00000000
      )
    ;; m
    #(#*00000000
      #*11100000
      #*11100000
      #*10100000
      #*10100000
      #*00000000
      )
    ;; n
    #(#*00000000
      #*11000000
      #*10100000
      #*10100000
      #*10100000
      #*00000000
      )
    ;; o
    #(#*00000000
      #*01000000
      #*10100000
      #*10100000
      #*01000000
      #*00000000
      )
    ;; p
    #(#*00000000
      #*11000000
      #*10100000
      #*10100000
      #*11000000
      #*10000000
      )
    ;; q
    #(#*00000000
      #*01100000
      #*10100000
      #*10100000
      #*01100000
      #*00100000
      )
    ;; r
    #(#*00000000
      #*01100000
      #*10000000
      #*10000000
      #*10000000
      #*00000000
      )
    ;; s
    #(#*00000000
      #*01100000
      #*11000000
      #*01100000
      #*11000000
      #*00000000
      )
    ;; t
    #(#*01000000
      #*11100000
      #*01000000
      #*01000000
      #*01100000
      #*00000000
      )
    ;; u
    #(#*00000000
      #*10100000
      #*10100000
      #*10100000
      #*11100000
      #*00000000
      )
    ;; v
    #(#*00000000
      #*10100000
      #*10100000
      #*10100000
      #*01000000
      #*00000000
      )
    ;; w
    #(#*00000000
      #*10100000
      #*10100000
      #*11100000
      #*11100000
      #*00000000
      )
    ;; x
    #(#*00000000
      #*10100000
      #*01000000
      #*01000000
      #*10100000
      #*00000000
      )
    ;; y
    #(#*00000000
      #*10100000
      #*10100000
      #*11100000
      #*00100000
      #*11000000
      )
    ;; z
    #(#*00000000
      #*11100000
      #*01100000
      #*10000000
      #*11100000
      #*00000000
      )
    ;; {
    #(#*01100000
      #*01000000
      #*11000000
      #*01000000
      #*01100000
      #*00000000
      )
    ;; |
    #(#*01000000
      #*01000000
      #*01000000
      #*01000000
      #*01000000
      #*00000000
      )
    ;; }
    #(#*11000000
      #*01000000
      #*01100000
      #*01000000
      #*11000000
      #*00000000
      )
    ;; ~
    #(#*00000000
      #*00100000
      #*11100000
      #*10000000
      #*00000000
      #*00000000
      )))
